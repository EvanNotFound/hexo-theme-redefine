const e={isBigImage:!1,scale:1,fitScale:1,userZoomed:!1,isMouseDown:!1,dragged:!1,currentImgIndex:0,lastMouseX:0,lastMouseY:0,translateX:0,translateY:0,maskDom:null,targetImg:null},t=".markdown-body img, .masonry-item img, #shuoshuo-content img",n={prevButton:null,nextButton:null,closeButton:null};let a=[],s=!1;const applyTransform=()=>{e.targetImg&&(e.targetImg.style.transform=`translate(${e.translateX}px, ${e.translateY}px) scale(${e.scale})`)},fitToViewport=(t={})=>{if(!e.targetImg)return;if(!(()=>{if(!e.maskDom)return null;const t=e.maskDom.querySelector(".image-viewer-frame");return t?t.getBoundingClientRect():e.maskDom.getBoundingClientRect()})())return;const n=t.marginFactor??.98;e.scale=1,e.translateX=0,e.translateY=0,applyTransform();const a=e.targetImg.getBoundingClientRect();if(!a.width||!a.height)return;const s=window.innerHeight*n,r=window.innerWidth,i=s/a.height,o=r/a.width,l=Math.min(1,i,o);e.fitScale=l,e.scale=l,e.translateX=0,e.translateY=0,e.userZoomed=!1,applyTransform()},showHandle=t=>{e.maskDom&&(document.body.style.overflow=t?"hidden":"auto",e.maskDom.classList.toggle("active",t))},closeViewer=()=>{e.isBigImage&&(e.isBigImage=!1,showHandle(!1),fitToViewport(),e.userZoomed=!1)},updateImageNodes=()=>{a=Array.from(document.querySelectorAll(t))},canGoPrev=()=>e.currentImgIndex>0,canGoNext=()=>e.currentImgIndex<Math.max(a.length-1,0),updateNavButtons=()=>{n.prevButton&&n.nextButton&&(n.prevButton.classList.toggle("is-disabled",!canGoPrev()),n.nextButton.classList.toggle("is-disabled",!canGoNext()))},updateViewerImage=t=>{const n=a[t];if(!n||!e.targetImg)return;e.currentImgIndex=t;let s=n.src;n.hasAttribute("lazyload")&&(s=n.getAttribute("data-src")||s,s&&(n.src=s),n.removeAttribute("lazyload")),s&&(e.targetImg.src=s),e.targetImg.alt=n.alt||"";const handleImageLoad=()=>{e.targetImg?.removeEventListener("load",handleImageLoad),fitToViewport()};e.targetImg.complete?fitToViewport():e.targetImg.addEventListener("load",handleImageLoad,{once:!0}),updateNavButtons()},goPrev=()=>{e.isBigImage&&canGoPrev()&&updateViewerImage(e.currentImgIndex-1)},goNext=()=>{e.isBigImage&&canGoNext()&&updateViewerImage(e.currentImgIndex+1)},handleArrowKeys=t=>{if(e.isBigImage)return"Escape"===t.key?(t.preventDefault(),void closeViewer()):"ArrowUp"===t.key||"ArrowLeft"===t.key?(t.preventDefault(),void goPrev()):void("ArrowDown"!==t.key&&"ArrowRight"!==t.key||(t.preventDefault(),goNext()))};export default function initImageViewer({signal:r,appSignal:i}={}){const o=document.querySelector(".image-viewer-container");if(!o)return void console.warn("Image viewer container not found. Exiting imageViewer function.");const l=o.querySelector("img");if(!l)return void console.warn("Target image not found in image viewer container. Exiting imageViewer function.");e.maskDom=o,e.targetImg=l,e.dragged=!1,n.prevButton=o.querySelector(".image-viewer-prev"),n.nextButton=o.querySelector(".image-viewer-next"),n.closeButton=o.querySelector(".image-viewer-close"),updateImageNodes(),(e=>{s||(s=!0,e?document.addEventListener("keydown",handleArrowKeys,{signal:e}):document.addEventListener("keydown",handleArrowKeys))})(i),updateNavButtons();const zoomHandle=t=>{if(!t.ctrlKey)return;if(t.preventDefault(),!e.targetImg)return;const n=e.targetImg.getBoundingClientRect(),a=t.clientX-n.left,s=t.clientY-n.top,r=a-n.width/2,i=s-n.height/2,o=e.scale,l=Math.max(.2,.8*e.fitScale),g=Math.min(8,4*e.fitScale);e.scale+=-.001*t.deltaY,e.scale=Math.min(Math.max(l,e.scale),g),e.userZoomed=Math.abs(e.scale-e.fitScale)>.01,o<e.scale?(e.translateX-=r*(e.scale-o),e.translateY-=i*(e.scale-o)):(e.translateX=0,e.translateY=0),applyTransform()},dragStartHandle=t=>{t.preventDefault(),e.isMouseDown=!0,e.lastMouseX=t.clientX,e.lastMouseY=t.clientY,e.targetImg.style.cursor="grabbing",e.userZoomed=!0};let g=0;const dragHandle=t=>{if(!e.isMouseDown)return;const n=(new Date).getTime();if(n-g<100)return;g=n;const a=t.clientX-e.lastMouseX,s=t.clientY-e.lastMouseY;e.translateX+=a,e.translateY+=s,e.lastMouseX=t.clientX,e.lastMouseY=t.clientY,applyTransform(),e.dragged=!0},dragEndHandle=t=>{e.isMouseDown&&t.stopPropagation(),e.isMouseDown=!1,e.dragged=!1,e.targetImg.style.cursor="grab"},handleImageClick=n=>{const s=n.target.closest(t);if(!s||s.closest(".image-viewer-container"))return;updateImageNodes();const r=a.indexOf(s);e.isBigImage=!0,e.dragged=!1,e.userZoomed=!1,showHandle(!0),updateViewerImage(-1===r?0:r)},handleMaskClick=t=>{t.target===o&&(e.dragged||closeViewer(),e.dragged=!1)},handlePrevClick=e=>{e.stopPropagation(),goPrev()},handleNextClick=e=>{e.stopPropagation(),goNext()},handleCloseClick=e=>{e.stopPropagation(),closeViewer()},handleResize=()=>{e.isBigImage&&!e.userZoomed&&fitToViewport()};r?(l.addEventListener("wheel",zoomHandle,{passive:!1,signal:r}),l.addEventListener("mousedown",dragStartHandle,{passive:!1,signal:r}),l.addEventListener("mousemove",dragHandle,{passive:!1,signal:r}),l.addEventListener("mouseup",dragEndHandle,{passive:!1,signal:r}),l.addEventListener("mouseleave",dragEndHandle,{passive:!1,signal:r}),o.addEventListener("click",handleMaskClick,{signal:r}),window.addEventListener("resize",handleResize,{signal:r}),document.addEventListener("click",handleImageClick,{signal:r}),n.prevButton?.addEventListener("click",handlePrevClick,{signal:r}),n.nextButton?.addEventListener("click",handleNextClick,{signal:r}),n.closeButton?.addEventListener("click",handleCloseClick,{signal:r})):(l.addEventListener("wheel",zoomHandle,{passive:!1}),l.addEventListener("mousedown",dragStartHandle,{passive:!1}),l.addEventListener("mousemove",dragHandle,{passive:!1}),l.addEventListener("mouseup",dragEndHandle,{passive:!1}),l.addEventListener("mouseleave",dragEndHandle,{passive:!1}),o.addEventListener("click",handleMaskClick),window.addEventListener("resize",handleResize),document.addEventListener("click",handleImageClick),n.prevButton?.addEventListener("click",handlePrevClick),n.nextButton?.addEventListener("click",handleNextClick),n.closeButton?.addEventListener("click",handleCloseClick))}
//# sourceMappingURL=imageViewer.js.map