const e=new WeakSet,getRoot=()=>{if("undefined"==typeof window)return"/";const e=window.config?.root||"/";return e.endsWith("/")?e:`${e}/`},getBaseWidth=()=>window.innerWidth>=768?255:150,ensureImageLoaded=e=>{if(!e||!e.hasAttribute("lazyload"))return;const t=e.getAttribute("data-src");t&&(e.src=t),e.removeAttribute("lazyload"),delete e.dataset.redefineLazyloadObserved};export default function initMasonry({signal:t}={}){const n=document.querySelector("#masonry-container");if(!n)return;if(e.has(n))return;if(e.add(n),"undefined"==typeof MiniMasonry)return void console.error("MiniMasonry is not available.");const r=document.querySelector("#masonry-loadmore"),i=document.querySelector("#masonry-sentinel"),a=n.dataset.masonryDataUrl||`${getRoot()}masonry/data.json`,s=Number.parseInt(window.theme?.page_templates?.masonry?.batch_size,10),o=Number.parseInt(window.theme?.page_templates?.masonry?.initial_batch_size,10);if(Number.isFinite(s)||console.warn("[redefine] page_templates.masonry.batch_size is missing."),Number.isFinite(o)||console.warn("[redefine] page_templates.masonry.initial_batch_size is missing."),!a)return void console.warn("Masonry data url is missing.");const d=new MiniMasonry({baseWidth:getBaseWidth(),container:n,gutterX:10,gutterY:10,surroundingGutter:!1}),l=(e=>{let t=null;return()=>{null===t&&(t=window.requestAnimationFrame(()=>{t=null,e()}))}})(()=>{d.layout()});let c=[],m=0,u=!1;const g=Number.isFinite(o)?Math.max(1,o):24,h=Number.isFinite(s)?Math.max(1,s):12,f="undefined"!=typeof IntersectionObserver,p=f?new IntersectionObserver(e=>{e.forEach(e=>{if(!e.isIntersecting)return;const t=e.target;p.unobserve(t),ensureImageLoaded(t)})},{rootMargin:"200px 0px",threshold:.1}):null,renderItem=e=>{const n=document.createElement("div");n.className="masonry-item";const r=document.createElement("div");r.className="image-container";const i=document.createElement("img");i.className="masonry-img is-loading",i.alt=e.title||"",i.setAttribute("lazyload",""),i.setAttribute("data-src",e.image),i.src=`${getRoot()}images/loading.svg`;const handleImageLoaded=()=>{i.hasAttribute("lazyload")||(i.classList.remove("is-loading"),l())};if(t?(i.addEventListener("load",handleImageLoaded,{signal:t}),i.addEventListener("error",handleImageLoaded,{signal:t})):(i.addEventListener("load",handleImageLoaded),i.addEventListener("error",handleImageLoaded)),p?p.observe(i):ensureImageLoaded(i),r.appendChild(i),e.title){const t=document.createElement("div");t.className="image-title",t.textContent=e.title,r.appendChild(t)}if(e.description){const t=document.createElement("div");t.className="image-description",t.textContent=e.description,r.appendChild(t)}return n.appendChild(r),n},toggleLoading=e=>{r&&r.classList.toggle("is-hidden",!e)},appendBatch=e=>{const t=c.slice(m,m+e);if(0===t.length)return!1;const r=document.createDocumentFragment();return t.forEach(e=>{r.appendChild(renderItem(e))}),n.appendChild(r),m+=t.length,l(),m<c.length},y=i&&f?new IntersectionObserver(e=>{e.some(e=>e.isIntersecting)&&(()=>{if(u)return;u=!0,toggleLoading(!0);const e=appendBatch(h);u=!1,toggleLoading(!1),!e&&i&&y&&(y.disconnect(),i.remove())})()},{rootMargin:"200px 0px",threshold:.1}):null,handleResize=()=>{d.conf.baseWidth=getBaseWidth(),l()};t?(window.addEventListener("resize",handleResize,{signal:t}),t.addEventListener("abort",()=>{p?.disconnect(),y?.disconnect()})):window.addEventListener("resize",handleResize);(async()=>{toggleLoading(!0);try{const e=await fetch(a);if(!e.ok)throw new Error(`Request failed with status ${e.status}`);c=await e.json()}catch(e){return console.error("Failed to load masonry data:",e),toggleLoading(!1),void(i&&i.remove())}if(!Array.isArray(c)||0===c.length)return toggleLoading(!1),void(i&&i.remove());if(appendBatch(g),toggleLoading(!1),m<c.length)if(i&&y)y.observe(i);else for(;m<c.length;)appendBatch(h);else i&&i.remove()})()}
//# sourceMappingURL=masonry.js.map